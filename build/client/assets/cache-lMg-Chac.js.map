{"version":3,"file":"cache-lMg-Chac.js","sources":["../../../app/routes/admin+/cache.tsx"],"sourcesContent":["import { invariantResponse } from '@epic-web/invariant'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tjson,\n\tredirect,\n\ttype LoaderFunctionArgs,\n\ttype ActionFunctionArgs,\n} from '@remix-run/node'\nimport {\n\tForm,\n\tLink,\n\tuseFetcher,\n\tuseLoaderData,\n\tuseSearchParams,\n\tuseSubmit,\n} from '@remix-run/react'\nimport { GeneralErrorBoundary } from '#app/components/error-boundary'\nimport { Field } from '#app/components/forms.tsx'\nimport { Spacer } from '#app/components/spacer.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport {\n\tcache,\n\tgetAllCacheKeys,\n\tlruCache,\n\tsearchCacheKeys,\n} from '#app/utils/cache.server.ts'\nimport {\n\tensureInstance,\n\tgetAllInstances,\n\tgetInstanceInfo,\n} from '#app/utils/litefs.server.ts'\nimport { useDebounce, useDoubleCheck } from '#app/utils/misc.tsx'\nimport { requireUserWithRole } from '#app/utils/permissions.server.ts'\n\nexport const handle: SEOHandle = {\n\tgetSitemapEntries: () => null,\n}\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst searchParams = new URL(request.url).searchParams\n\tconst query = searchParams.get('query')\n\tif (query === '') {\n\t\tsearchParams.delete('query')\n\t\treturn redirect(`/admin/cache?${searchParams.toString()}`)\n\t}\n\tconst limit = Number(searchParams.get('limit') ?? 100)\n\n\tconst currentInstanceInfo = await getInstanceInfo()\n\tconst instance =\n\t\tsearchParams.get('instance') ?? currentInstanceInfo.currentInstance\n\tconst instances = await getAllInstances()\n\tawait ensureInstance(instance)\n\n\tlet cacheKeys: { sqlite: Array<string>; lru: Array<string> }\n\tif (typeof query === 'string') {\n\t\tcacheKeys = await searchCacheKeys(query, limit)\n\t} else {\n\t\tcacheKeys = await getAllCacheKeys(limit)\n\t}\n\treturn json({ cacheKeys, instance, instances, currentInstanceInfo })\n}\n\nexport async function action({ request }: ActionFunctionArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst formData = await request.formData()\n\tconst key = formData.get('cacheKey')\n\tconst { currentInstance } = await getInstanceInfo()\n\tconst instance = formData.get('instance') ?? currentInstance\n\tconst type = formData.get('type')\n\n\tinvariantResponse(typeof key === 'string', 'cacheKey must be a string')\n\tinvariantResponse(typeof type === 'string', 'type must be a string')\n\tinvariantResponse(typeof instance === 'string', 'instance must be a string')\n\tawait ensureInstance(instance)\n\n\tswitch (type) {\n\t\tcase 'sqlite': {\n\t\t\tawait cache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tcase 'lru': {\n\t\t\tlruCache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tdefault: {\n\t\t\tthrow new Error(`Unknown cache type: ${type}`)\n\t\t}\n\t}\n\treturn json({ success: true })\n}\n\nexport default function CacheAdminRoute() {\n\tconst data = useLoaderData<typeof loader>()\n\tconst [searchParams] = useSearchParams()\n\tconst submit = useSubmit()\n\tconst query = searchParams.get('query') ?? ''\n\tconst limit = searchParams.get('limit') ?? '100'\n\tconst instance = searchParams.get('instance') ?? data.instance\n\n\tconst handleFormChange = useDebounce((form: HTMLFormElement) => {\n\t\tsubmit(form)\n\t}, 400)\n\n\treturn (\n\t\t<div className=\"container\">\n\t\t\t<h1 className=\"text-h1\">Cache Admin</h1>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<Form\n\t\t\t\tmethod=\"get\"\n\t\t\t\tclassName=\"flex flex-col gap-4\"\n\t\t\t\tonChange={e => handleFormChange(e.currentTarget)}\n\t\t\t>\n\t\t\t\t<div className=\"flex-1\">\n\t\t\t\t\t<div className=\"flex flex-1 gap-4\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\tclassName=\"flex h-16 items-center justify-center\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tðŸ”Ž\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<Field\n\t\t\t\t\t\t\tclassName=\"flex-1\"\n\t\t\t\t\t\t\tlabelProps={{ children: 'Search' }}\n\t\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\t\ttype: 'search',\n\t\t\t\t\t\t\t\tname: 'query',\n\t\t\t\t\t\t\t\tdefaultValue: query,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div className=\"flex h-16 w-14 items-center text-lg font-medium text-muted-foreground\">\n\t\t\t\t\t\t\t<span title=\"Total results shown\">\n\t\t\t\t\t\t\t\t{data.cacheKeys.sqlite.length + data.cacheKeys.lru.length}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"flex flex-wrap items-center gap-4\">\n\t\t\t\t\t<Field\n\t\t\t\t\t\tlabelProps={{\n\t\t\t\t\t\t\tchildren: 'Limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\tname: 'limit',\n\t\t\t\t\t\t\tdefaultValue: limit,\n\t\t\t\t\t\t\ttype: 'number',\n\t\t\t\t\t\t\tstep: '1',\n\t\t\t\t\t\t\tmin: '1',\n\t\t\t\t\t\t\tmax: '10000',\n\t\t\t\t\t\t\tplaceholder: 'results limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t\t<select name=\"instance\" defaultValue={instance}>\n\t\t\t\t\t\t{Object.entries(data.instances).map(([inst, region]) => (\n\t\t\t\t\t\t\t<option key={inst} value={inst}>\n\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\tinst,\n\t\t\t\t\t\t\t\t\t`(${region})`,\n\t\t\t\t\t\t\t\t\tinst === data.currentInstanceInfo.currentInstance\n\t\t\t\t\t\t\t\t\t\t? '(current)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t\tinst === data.currentInstanceInfo.primaryInstance\n\t\t\t\t\t\t\t\t\t\t? ' (primary)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t.filter(Boolean)\n\t\t\t\t\t\t\t\t\t.join(' ')}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</Form>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">LRU Cache:</h2>\n\t\t\t\t{data.cacheKeys.lru.map(key => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"lru\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t\t<Spacer size=\"3xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">SQLite Cache:</h2>\n\t\t\t\t{data.cacheKeys.sqlite.map(key => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"sqlite\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nfunction CacheKeyRow({\n\tcacheKey,\n\tinstance,\n\ttype,\n}: {\n\tcacheKey: string\n\tinstance?: string\n\ttype: 'sqlite' | 'lru'\n}) {\n\tconst fetcher = useFetcher<typeof action>()\n\tconst dc = useDoubleCheck()\n\tconst encodedKey = encodeURIComponent(cacheKey)\n\tconst valuePage = `/admin/cache/${type}/${encodedKey}?instance=${instance}`\n\treturn (\n\t\t<div className=\"flex items-center gap-2 font-mono\">\n\t\t\t<fetcher.Form method=\"POST\">\n\t\t\t\t<input type=\"hidden\" name=\"cacheKey\" value={cacheKey} />\n\t\t\t\t<input type=\"hidden\" name=\"instance\" value={instance} />\n\t\t\t\t<input type=\"hidden\" name=\"type\" value={type} />\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t{...dc.getButtonProps({ type: 'submit' })}\n\t\t\t\t>\n\t\t\t\t\t{fetcher.state === 'idle'\n\t\t\t\t\t\t? dc.doubleCheck\n\t\t\t\t\t\t\t? 'You sure?'\n\t\t\t\t\t\t\t: 'Delete'\n\t\t\t\t\t\t: 'Deleting...'}\n\t\t\t\t</Button>\n\t\t\t</fetcher.Form>\n\t\t\t<Link reloadDocument to={valuePage}>\n\t\t\t\t{cacheKey}\n\t\t\t</Link>\n\t\t</div>\n\t)\n}\n\nexport function ErrorBoundary() {\n\treturn (\n\t\t<GeneralErrorBoundary\n\t\t\tstatusHandlers={{\n\t\t\t\t403: ({ error }) => (\n\t\t\t\t\t<p>You are not allowed to do that: {error?.data.message}</p>\n\t\t\t\t),\n\t\t\t}}\n\t\t/>\n\t)\n}\n"],"names":["handle","CacheAdminRoute","data","useLoaderData","searchParams","useSearchParams","submit","useSubmit","query","limit","instance","handleFormChange","useDebounce","form","jsxs","jsx","Spacer","Form","e","Field","inst","region","key","CacheKeyRow","cacheKey","type","fetcher","useFetcher","dc","useDoubleCheck","encodedKey","valuePage","Button","Link","ErrorBoundary","GeneralErrorBoundary","error"],"mappings":"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"}